<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Settings - OrgSuite Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="/js/config.js?v=6"></script>
    <script src="/js/config.modules.js?v=1"></script>
    <script src="/js/ui.js?v=2"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/app.js?v=7"></script>
    <script src="/js/layout.js?v=2"></script>
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: #ECFDF5;
            color: #059669;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .chip button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            margin-left: 0.25rem;
            color: #10B981;
        }
        .chip.status {
            background: #FEF3C7;
            color: #D97706;
        }
        .chip.status button {
            color: #F59E0B;
        }
    </style>
</head>
<body class="app-shell">
    <!-- Shared Header (rendered by Layout.js) -->
    <header class="app-header"></header>

    <!-- Module Navigation -->
    <nav class="module-nav"></nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-main-inner">
            <!-- Hidden org selector for test compatibility -->
            <select id="org-selector" data-testid="org-selector" class="hidden" onchange="loadSettings()">
                <option value="">Loading organizations...</option>
            </select>

            <!-- Page Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                        <a href="/pages/organizations.html" class="hover:text-blue-600">Organizations</a>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span class="text-gray-700">Admin</span>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span class="text-gray-900 font-medium">Membership Settings</span>
                    </nav>
                    <h1 class="text-3xl font-bold text-gray-900">Membership Settings</h1>
                    <p class="text-gray-500 mt-2">Configure member types, statuses, and options</p>
                </div>
            </div>

            <!-- Admin Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2 mb-6">
                <div class="flex gap-2">
                    <a href="/pages/admin_org_settings.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">General</a>
                    <a href="/pages/admin_governance.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">Governance</a>
                    <a href="/pages/admin_membership.html" class="flex-1 px-4 py-2.5 text-center rounded-lg bg-blue-50 text-blue-700 font-medium">Membership</a>
                    <a href="/pages/admin_finance.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">Finance</a>
                </div>
            </div>

            <!-- Settings Form -->
            <div id="settings-content" class="space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" class="text-green-600">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Member Configuration</h2>
                            <p class="text-sm text-gray-500">Customize member types, statuses, and fields</p>
                        </div>
                    </div>

                    <form id="membership-settings-form" class="space-y-5">
                        <!-- Member Types -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Member Types</label>
                            <p class="text-xs text-gray-500 mb-2">Categories of membership (e.g., Regular, Board, Volunteer)</p>
                            <div id="member-types-container" class="flex flex-wrap gap-2 p-3 border border-gray-200 rounded-xl min-h-[50px] mb-2">
                                <!-- Chips will be added here -->
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="new-member-type" placeholder="Add member type..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="addMemberType()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Add</button>
                            </div>
                        </div>

                        <!-- Member Statuses -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Member Statuses</label>
                            <p class="text-xs text-gray-500 mb-2">Status values for members (e.g., Active, Inactive, Pending)</p>
                            <div id="member-statuses-container" class="flex flex-wrap gap-2 p-3 border border-gray-200 rounded-xl min-h-[50px] mb-2">
                                <!-- Chips will be added here -->
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="new-member-status" placeholder="Add member status..."
                                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" onclick="addMemberStatus()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Add</button>
                            </div>
                        </div>

                        <!-- Member ID Format -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Member ID Format</label>
                            <input type="text" id="setting-id-format"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   value="ORG-{year}-{seq:04d}" placeholder="ORG-{year}-{seq:04d}">
                            <p class="text-xs text-gray-500 mt-1">{year} = current year, {seq} = sequence number. Use :04d for zero-padding.</p>
                        </div>

                        <!-- Required Fields -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Required Fields</label>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="setting-require-email"
                                           class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-gray-700">Require email address for all members</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="setting-require-phone"
                                           class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="text-gray-700">Require phone number for all members</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex gap-3 justify-end pt-5 border-t border-gray-100">
                            <button type="button" onclick="loadSettings()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">Reset</button>
                            <button type="submit" id="save-settings-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-sm">
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
        <p>&copy; 2024 OrgSuite. Open-source organization management platform.</p>
    </footer>

    <script>
        let currentOrgId = '';
        let memberTypes = [];
        let memberStatuses = [];

        const defaultMemberTypes = ['Regular', 'Associate', 'Lifetime', 'Student', 'Board', 'Volunteer', 'Staff'];
        const defaultMemberStatuses = ['Active', 'Inactive', 'Pending', 'Alumni', 'Guest', 'Honorary', 'Suspended'];

        document.addEventListener('DOMContentLoaded', async () => {
            App.init();
            if (!App.requireAuth()) return;

            // Initialize Layout with membership module
            Layout.init({ module: 'membership' });
            Layout.renderModuleNav('membership', 'admin_membership');

            await loadOrganizations();

            // Listen for org changes from Layout
            window.addEventListener('orgchange', async (e) => {
                document.getElementById('org-selector').value = e.detail.orgId;
                loadSettings();
            });

            document.getElementById('membership-settings-form').addEventListener('submit', saveSettings);

            // Enter key handlers
            document.getElementById('new-member-type').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addMemberType(); }
            });
            document.getElementById('new-member-status').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addMemberStatus(); }
            });
        });

        async function loadOrganizations() {
            const selector = document.getElementById('org-selector');
            try {
                const orgs = await App.getOrganizations();
                const adminOrgs = orgs.filter(org =>
                    org.user_role === 'owner' || org.user_role === 'admin'
                );

                if (adminOrgs.length === 0) {
                    selector.innerHTML = '<option value="">No organizations with admin access</option>';
                } else {
                    selector.innerHTML = '<option value="">Select organization...</option>' +
                        adminOrgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');

                    const urlOrgId = App.getUrlParam('org');
                    if (urlOrgId && adminOrgs.find(o => o.id === urlOrgId)) {
                        selector.value = urlOrgId;
                        loadSettings();
                    } else if (adminOrgs.length === 1) {
                        selector.value = adminOrgs[0].id;
                        loadSettings();
                    }
                }
            } catch (err) {
                console.error('Failed to load organizations:', err);
                selector.innerHTML = '<option value="">Error loading organizations</option>';
            }
        }

        async function loadSettings() {
            const orgId = document.getElementById('org-selector').value;
            if (!orgId) return;

            currentOrgId = orgId;

            try {
                const response = await fetch(`/api/v1/admin/org-settings/effective?organization_id=${orgId}&scope=membership`, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                let config = {};
                if (response.ok) {
                    const data = await response.json();
                    config = data.settings.membership || {};
                }

                // Populate form
                document.getElementById('setting-id-format').value = config.member_id_format || 'ORG-{year}-{seq:04d}';
                document.getElementById('setting-require-email').checked = config.require_email || false;
                document.getElementById('setting-require-phone').checked = config.require_phone || false;

                // Member types
                memberTypes = config.member_types || [...defaultMemberTypes];
                renderMemberTypes();

                // Member statuses
                memberStatuses = config.member_statuses || [...defaultMemberStatuses];
                renderMemberStatuses();

            } catch (err) {
                console.error('Failed to load settings:', err);
                memberTypes = [...defaultMemberTypes];
                memberStatuses = [...defaultMemberStatuses];
                renderMemberTypes();
                renderMemberStatuses();
            }
        }

        function renderMemberTypes() {
            const container = document.getElementById('member-types-container');
            container.innerHTML = memberTypes.map((type, idx) => `
                <span class="chip">
                    ${type}
                    <button type="button" onclick="removeMemberType(${idx})">&times;</button>
                </span>
            `).join('');
        }

        function renderMemberStatuses() {
            const container = document.getElementById('member-statuses-container');
            container.innerHTML = memberStatuses.map((status, idx) => `
                <span class="chip status">
                    ${status}
                    <button type="button" onclick="removeMemberStatus(${idx})">&times;</button>
                </span>
            `).join('');
        }

        function addMemberType() {
            const input = document.getElementById('new-member-type');
            const value = input.value.trim();
            if (value && !memberTypes.includes(value)) {
                memberTypes.push(value);
                renderMemberTypes();
                input.value = '';
            }
        }

        function removeMemberType(idx) {
            memberTypes.splice(idx, 1);
            renderMemberTypes();
        }

        function addMemberStatus() {
            const input = document.getElementById('new-member-status');
            const value = input.value.trim();
            if (value && !memberStatuses.includes(value)) {
                memberStatuses.push(value);
                renderMemberStatuses();
                input.value = '';
            }
        }

        function removeMemberStatus(idx) {
            memberStatuses.splice(idx, 1);
            renderMemberStatuses();
        }

        async function saveSettings(event) {
            event.preventDefault();

            if (!currentOrgId) {
                App.showNotification('Please select an organization first', 'error');
                return;
            }

            const btn = document.getElementById('save-settings-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const config = {
                    member_types: memberTypes,
                    member_statuses: memberStatuses,
                    member_id_format: document.getElementById('setting-id-format').value,
                    require_email: document.getElementById('setting-require-email').checked,
                    require_phone: document.getElementById('setting-require-phone').checked
                };

                const response = await fetch(`/api/v1/admin/org-settings/by-key?organization_id=${currentOrgId}&scope=membership&key=membership_config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    },
                    body: JSON.stringify({ value: config })
                });

                if (!response.ok) throw new Error('Failed to save settings');

                App.showNotification('Membership settings saved!', 'success');
            } catch (err) {
                console.error('Failed to save settings:', err);
                App.showNotification('Failed to save settings', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Settings';
            }
        }
    </script>
</body>
</html>
