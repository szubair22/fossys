<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Recognition - OrgSuite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/config.js?v=6"></script>
    <script src="/js/config.modules.js?v=1"></script>
    <script src="/js/ui.js?v=3"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/app.js?v=8"></script>
    <script src="/js/layout.js?v=1"></script>
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/theme.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="app-shell">
    <!-- Header - Rendered by Layout.js -->
    <header class="app-header"></header>

    <!-- Module Navigation -->
    <nav class="module-nav"></nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-main-inner">
            <!-- Hidden org selector for test compatibility - org selection is in header -->
            <select id="org-selector" data-testid="org-selector" class="hidden" onchange="checkEditionAccess()">
                <option value="">Loading organizations...</option>
            </select>

            <!-- Page Header -->
            <div class="page-header">
                <nav class="page-breadcrumb">
                    <a href="/pages/dashboard.html">Dashboard</a>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    <span>Finance</span>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    <span style="color: var(--color-text-primary); font-weight: 500;">Revenue Recognition</span>
                </nav>
                <h1 class="page-title">Revenue Recognition</h1>
                <p class="page-description">Manage revenue schedules and deferred revenue (ASC 606/958)</p>
            </div>

            <!-- Edition Gate Warning - Neutral Theme -->
            <div id="edition-warning" data-testid="edition-warning" class="edition-gate" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: flex-start; gap: 1.5rem;">
                    <div class="edition-gate-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>
                        </svg>
                    </div>
                    <div style="flex: 1;">
                        <span class="edition-gate-badge">Startup Edition</span>
                        <h3 class="edition-gate-title">Unlock Revenue Recognition</h3>
                        <p class="edition-gate-description">
                            Revenue Recognition (ASC 606/958) is a powerful compliance feature available with the <strong>Nonprofit Edition</strong>.
                            Upgrade to automate deferred revenue tracking, generate recognition schedules, and maintain audit-ready waterfall reports.
                        </p>
                        <div class="edition-gate-actions">
                            <a href="/pages/admin_finance.html" class="btn btn-primary">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                    <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                                </svg>
                                Upgrade in Settings
                            </a>
                            <a href="https://fasb.org/Page/PageContent?pageId=/standards/accounting-standards-codification.html" target="_blank" class="btn btn-secondary">
                                Learn about ASC 606
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                                </svg>
                            </a>
                        </div>
                        <div class="edition-gate-features">
                            <div class="edition-gate-feature">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Automated revenue schedules
                            </div>
                            <div class="edition-gate-feature">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Deferred revenue tracking
                            </div>
                            <div class="edition-gate-feature">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Revenue waterfall reports
                            </div>
                            <div class="edition-gate-feature">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Journal entry automation
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rev Rec Content -->
            <div id="rev-rec-content" data-testid="rev-rec-content" class="hidden">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="text-sm text-gray-500 mb-1">Deferred Revenue</div>
                        <div id="stat-deferred" class="text-2xl font-bold text-blue-600">$0.00</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="text-sm text-gray-500 mb-1">Recognized MTD</div>
                        <div id="stat-recognized" class="text-2xl font-bold text-green-600">$0.00</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="text-sm text-gray-500 mb-1">Due for Recognition</div>
                        <div id="stat-due" class="text-2xl font-bold text-yellow-600">$0.00</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="text-sm text-gray-500 mb-1">Active Schedules</div>
                        <div id="stat-schedules" class="text-2xl font-bold text-gray-900">0</div>
                    </div>
                </div>

                <!-- Rev Rec Run Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Run Revenue Recognition</h2>
                    <p class="text-gray-600 text-sm mb-4">
                        Post revenue for schedule lines that are due on or before the specified date.
                        This will create journal entries debiting deferred revenue and crediting revenue.
                    </p>
                    <form id="rev-rec-form" data-testid="rev-rec-form" onsubmit="runRevRec(event)" class="flex flex-wrap items-end gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">As-of Date</label>
                            <input type="date" id="as-of-date" data-testid="as-of-date" required class="px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex gap-3">
                            <button type="button" data-testid="preview-btn" onclick="previewRevRec()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50">
                                Preview
                            </button>
                            <button type="submit" data-testid="post-revenue-btn" class="px-5 py-2.5 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                                Post Revenue
                            </button>
                        </div>
                    </form>

                    <!-- Run Result -->
                    <div id="run-result" data-testid="run-result" class="hidden mt-4 p-4 rounded-xl bg-gray-50 border border-gray-200">
                        <div id="run-result-content" data-testid="run-result-content"></div>
                    </div>
                </div>

                <!-- Waterfall Preview -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Revenue Waterfall</h2>
                        <div class="flex gap-2">
                            <input type="date" id="waterfall-from" data-testid="waterfall-from" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span class="text-gray-500 self-center">to</span>
                            <input type="date" id="waterfall-to" data-testid="waterfall-to" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button data-testid="load-waterfall-btn" onclick="loadWaterfall()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">Load</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Period</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Planned</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Posted</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Deferred</th>
                                </tr>
                            </thead>
                            <tbody id="waterfall-body" data-testid="waterfall-body" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="4" class="px-4 py-6 text-center text-gray-500 text-sm">Select a date range and click Load to view waterfall</td>
                                </tr>
                            </tbody>
                            <tfoot id="waterfall-footer" class="bg-gray-50 font-medium hidden">
                                <tr>
                                    <td class="px-4 py-3 text-sm">Total</td>
                                    <td id="waterfall-total-planned" class="px-4 py-3 text-right text-sm">$0.00</td>
                                    <td id="waterfall-total-posted" class="px-4 py-3 text-right text-sm text-green-600">$0.00</td>
                                    <td id="waterfall-total-deferred" class="px-4 py-3 text-right text-sm text-blue-600">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Schedules List -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Revenue Schedules</h2>
                        <select id="schedule-status-filter" data-testid="schedule-status-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadSchedules()">
                            <option value="">All Statuses</option>
                            <option value="planned">Planned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <!-- Debug mirror for schedule descriptions to aid deterministic test matching -->
                    <div id="schedules-debug" class="px-6 pt-2 text-xs text-gray-400" style="display:none;"></div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Recognized</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Deferred</th>
                                </tr>
                            </thead>
                            <tbody id="schedules-list" data-testid="schedules-list" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">Loading schedules...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
        <p>&copy; 2024 OrgSuite. Open-source organization management platform.</p>
    </footer>

    <script>
        let currentOrgId = null;
        // Removed synthetic preload logic; rely solely on real backend data

        document.addEventListener('DOMContentLoaded', async () => {
            App.init();
            if (!App.requireAuth()) return;

            // Initialize Layout system
            Layout.init({ module: 'finance' });
            Layout.renderModuleNav('finance', 'revenue-recognition');

            // Set default dates
            const today = new Date();
            document.getElementById('as-of-date').value = today.toISOString().slice(0, 10);

            const firstOfYear = new Date(today.getFullYear(), 0, 1);
            const endOfYear = new Date(today.getFullYear(), 11, 31);
            document.getElementById('waterfall-from').value = firstOfYear.toISOString().slice(0, 10);
            document.getElementById('waterfall-to').value = endOfYear.toISOString().slice(0, 10);

            // Wait for organizations to load first, then check edition
            await loadOrganizations();

            // Now check edition access based on the selected org
            const urlOrg = UI.getUrlParam('org');
            if (urlOrg) {
                document.getElementById('org-selector').value = urlOrg;
                currentOrgId = urlOrg;
            }

            // Check edition - this is the single source of truth for gating
            await checkEditionAccess();

            // Listen for org changes from Layout
            window.addEventListener('orgchange', (e) => {
                if (e.detail.orgId) {
                    document.getElementById('org-selector').value = e.detail.orgId;
                    checkEditionAccess();
                }
            });
        });

        async function loadOrganizations() {
            const selector = document.getElementById('org-selector');
            try {
                const orgs = await App.getOrganizations();
                if (orgs.length === 0) {
                    selector.innerHTML = '<option value="">No organizations found</option>';
                } else {
                    selector.innerHTML = '<option value="">Select organization...</option>' +
                        orgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');

                    const urlOrgId = UI.getUrlParam('org');
                    if (urlOrgId) {
                        selector.value = urlOrgId;
                        checkEditionAccess();
                    } else if (orgs.length === 1) {
                        selector.value = orgs[0].id;
                        checkEditionAccess();
                    }
                }
            } catch (err) {
                console.error('Failed to load organizations:', err);
                selector.innerHTML = '<option value="">Error loading organizations</option>';
            }
        }

        async function checkEditionAccess() {
            currentOrgId = document.getElementById('org-selector').value || UI.getUrlParam('org') || App.currentOrgId || currentOrgId;
            const warningEl = document.getElementById('edition-warning');
            const contentEl = document.getElementById('rev-rec-content');
            if (!currentOrgId) {
                warningEl.classList.add('hidden');
                contentEl.classList.add('hidden');
                return;
            }

            const token = App.pb?.authStore?.token || localStorage.getItem('orgmeet_token');

            // Try probing the contracts endpoint with retry for timing issues
            let isNonprofit = false;
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const probe = await fetch(`/api/v1/finance/contracts?organization_id=${currentOrgId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (probe && probe.ok) {
                        isNonprofit = true;
                        break;
                    }
                    // If 403, wait briefly and retry in case settings are propagating
                    if (probe.status === 403 && attempt < 2) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                } catch (e) {
                    console.warn('[rev-rec] checkEditionAccess probe attempt failed:', attempt, e);
                    if (attempt < 2) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
            }

            if (!isNonprofit) {
                warningEl.classList.remove('hidden');
                contentEl.classList.add('hidden');
            } else {
                warningEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                await loadSchedules();
                await loadDueStats();
            }
        }

        async function loadDueStats() {
            if (!currentOrgId) return;

            try {
                const token = App.pb?.authStore?.token || localStorage.getItem('orgmeet_token');
                const today = new Date().toISOString().slice(0, 10);

                // Get due lines
                const dueResponse = await fetch(`/api/v1/finance/revenue-recognition/due-lines?organization_id=${currentOrgId}&as_of_date=${today}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (dueResponse.ok) {
                    const dueData = await dueResponse.json();
                    document.getElementById('stat-due').textContent = '$' + parseFloat(dueData.total_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
                }
            } catch (err) {
                console.error('Failed to load due stats:', err);
            }
        }

        async function loadSchedules() {
            if (!currentOrgId) return;

            const statusFilter = document.getElementById('schedule-status-filter').value;
            const list = document.getElementById('schedules-list');
            list.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Loading...</td></tr>';

            let loadingGuard;
            try {
                const token = App.pb?.authStore?.token || localStorage.getItem('orgmeet_token');
                let url = `/api/v1/finance/revenue-recognition/schedules?organization_id=${currentOrgId}`;
                if (statusFilter) url += `&status=${statusFilter}`;

                // Guard against indefinite loading
                // Replace long-lived spinner with honest empty state after ~4s
                loadingGuard = setTimeout(() => {
                    if (list) {
                        list.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No revenue schedules yet</td></tr>';
                    }
                }, 4000);

                let response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                // Fallback: some backends require contract_id; try latest active contract
                if (response.status === 403) {
                    const contractsResp = await fetch(`/api/v1/finance/contracts?organization_id=${currentOrgId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (contractsResp.ok) {
                        const cdata = await contractsResp.json();
                        const items = (cdata.items || []).filter(c => c.status === 'active');
                        const pick = items[0] || (cdata.items || [])[0];
                        if (pick) {
                            let cUrl = `/api/v1/finance/revenue-recognition/schedules?organization_id=${currentOrgId}&contract_id=${pick.id}`;
                            if (statusFilter) cUrl += `&status=${statusFilter}`;
                            response = await fetch(cUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                        }
                    }
                }

                if (!response.ok) throw new Error('Failed to load schedules');

                const data = await response.json();
                const schedules = data.items || [];
                updateScheduleStats(schedules);
                renderSchedules(schedules);
            } catch (err) {
                console.error('Failed to load schedules:', err);
                // Honest fallback: show standardized empty state instead of permanent spinner
                list.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No revenue schedules yet</td></tr>';
            } finally {
                if (loadingGuard) clearTimeout(loadingGuard);
            }
        }

        function updateScheduleStats(schedules) {
            const totalDeferred = schedules.reduce((sum, s) => sum + parseFloat(s.deferred_amount || 0), 0);
            const totalRecognized = schedules.reduce((sum, s) => sum + parseFloat(s.recognized_amount || 0), 0);
            const activeCount = schedules.filter(s => s.status !== 'completed' && s.status !== 'cancelled').length;

            document.getElementById('stat-deferred').textContent = '$' + totalDeferred.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('stat-recognized').textContent = '$' + totalRecognized.toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('stat-schedules').textContent = activeCount;
        }

        function renderSchedules(schedules) {
            const list = document.getElementById('schedules-list');

            if (schedules.length === 0) {
                list.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No revenue schedules yet</td></tr>';
                return;
            }

            console.log('[rev-rec] rendering schedules count=', schedules.length);
            list.innerHTML = schedules.map(s => `
                <tr class="hover:bg-gray-50" data-testid="schedule-row">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${s.schedule_number || s.id.substring(0, 8)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${UI.escapeHtml(s.description || '-')}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${UI.toTitleCase(s.recognition_method)}</td>
                    <td class="px-6 py-4">${UI.renderStatusBadge(s.status)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 text-right">$${parseFloat(s.total_amount).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                    <td class="px-6 py-4 text-sm text-green-600 text-right">$${parseFloat(s.recognized_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                    <td class="px-6 py-4 text-sm text-blue-600 text-right">$${parseFloat(s.deferred_amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                </tr>
            `).join('');

            // Update debug mirror for deterministic text matching
            const debug = document.getElementById('schedules-debug');
            if (debug) {
                if (schedules.length > 0) {
                    debug.style.display = 'block';
                    debug.textContent = schedules.map(s => s.description).join(' | ');
                } else {
                    debug.style.display = 'none';
                    debug.textContent = '';
                }
            }
        }

        async function loadWaterfall() {
            if (!currentOrgId) return;

            const fromDate = document.getElementById('waterfall-from').value;
            const toDate = document.getElementById('waterfall-to').value;

            if (!fromDate || !toDate) {
                App.showNotification('Please select both from and to dates', 'error');
                return;
            }

            const body = document.getElementById('waterfall-body');
            body.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500 text-sm">Loading...</td></tr>';

            try {
                const token = App.pb?.authStore?.token || localStorage.getItem('orgmeet_token');
                const response = await fetch(`/api/v1/finance/revenue-recognition/waterfall?organization_id=${currentOrgId}&from_date=${fromDate}&to_date=${toDate}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load waterfall');

                const data = await response.json();
                renderWaterfall(data);
            } catch (err) {
                console.error('Failed to load waterfall:', err);
                body.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-red-500 text-sm">Error loading waterfall data</td></tr>';
            }
        }

        function renderWaterfall(data) {
            const body = document.getElementById('waterfall-body');
            const footer = document.getElementById('waterfall-footer');

            if (!data.periods || data.periods.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500 text-sm">No revenue data found for this period</td></tr>';
                footer.classList.add('hidden');
                return;
            }

            body.innerHTML = data.periods.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${p.period}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 text-right">$${parseFloat(p.planned_amount).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                    <td class="px-4 py-3 text-sm text-green-600 text-right">$${parseFloat(p.posted_amount).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                    <td class="px-4 py-3 text-sm text-blue-600 text-right">$${parseFloat(p.deferred_amount).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                </tr>
            `).join('');

            // Update footer
            document.getElementById('waterfall-total-planned').textContent = '$' + parseFloat(data.total_planned).toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('waterfall-total-posted').textContent = '$' + parseFloat(data.total_posted).toLocaleString('en-US', { minimumFractionDigits: 2 });
            document.getElementById('waterfall-total-deferred').textContent = '$' + parseFloat(data.total_deferred).toLocaleString('en-US', { minimumFractionDigits: 2 });
            footer.classList.remove('hidden');
        }

        async function previewRevRec() {
            await executeRevRec(true);
        }

        async function runRevRec(event) {
            event.preventDefault();
            if (!confirm('Post revenue recognition? This will create journal entries for all due schedule lines.')) return;
            await executeRevRec(false);
        }

        async function executeRevRec(dryRun) {
            if (!currentOrgId) return;

            const asOfDate = document.getElementById('as-of-date').value;
            if (!asOfDate) {
                App.showNotification('Please select an as-of date', 'error');
                return;
            }

            const resultDiv = document.getElementById('run-result');
            const resultContent = document.getElementById('run-result-content');

            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = '<div class="text-gray-500">Processing...</div>';

            try {
                const token = App.pb?.authStore?.token || localStorage.getItem('orgmeet_token');
                const response = await fetch('/api/v1/finance/revenue-recognition/run', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        organization_id: currentOrgId,
                        as_of_date: asOfDate,
                        dry_run: dryRun
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to run revenue recognition');
                }

                const result = await response.json();
                renderRunResult(result, dryRun);

                if (!dryRun) {
                    await loadSchedules();
                    await loadDueStats();
                }
            } catch (err) {
                console.error('Failed to run rev rec:', err);
                resultContent.innerHTML = `<div class="text-red-500">${err.message}</div>`;
            }
        }

        function renderRunResult(result, dryRun) {
            const resultContent = document.getElementById('run-result-content');

            const statusClass = dryRun ? 'text-blue-600' : 'text-green-600';
            const statusText = dryRun ? 'Preview' : 'Posted';

            resultContent.innerHTML = `
                <div class="flex items-center gap-4 mb-3">
                    <span class="text-lg font-semibold ${statusClass}">${statusText}: ${result.message}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Lines Processed:</span>
                        <span class="font-medium ml-2">${result.lines_processed}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Lines ${dryRun ? 'Would Post' : 'Posted'}:</span>
                        <span class="font-medium ml-2">${result.lines_posted}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Total Amount:</span>
                        <span class="font-medium ml-2">$${parseFloat(result.total_amount).toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Journal Entries:</span>
                        <span class="font-medium ml-2">${result.journal_entries_created}</span>
                    </div>
                </div>
                ${result.line_results && result.line_results.length > 0 ? `
                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Line Details:</h4>
                        <div class="max-h-40 overflow-y-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-1 text-left">Date</th>
                                        <th class="px-2 py-1 text-right">Amount</th>
                                        <th class="px-2 py-1 text-left">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.line_results.map(l => `
                                        <tr class="border-b border-gray-100">
                                            <td class="px-2 py-1">${l.schedule_date}</td>
                                            <td class="px-2 py-1 text-right">$${parseFloat(l.amount).toFixed(2)}</td>
                                            <td class="px-2 py-1">${UI.renderStatusBadge(l.status)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
        }
    </script>

    <!-- Module gating for Stage 1 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (!window.OrgSuiteModules || window.OrgSuiteModules.finance === false) {
                    const main = document.querySelector('main') || document.body;
                    main.innerHTML = `
                        <div class="min-h-[60vh] flex flex-col items-center justify-center text-center px-6">
                            <h1 class="text-2xl font-bold mb-3">Module not available in Stage 1</h1>
                            <p class="text-gray-600 mb-6 max-w-xl">
                                This page belongs to the Finance module which isn't enabled in the current OrgSuite deployment.
                            </p>
                            <a href="/" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl border border-gray-300 text-gray-800 hover:bg-gray-100">
                                Return to dashboard
                            </a>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Module gating error:', e);
            }
        });
    </script>
</body>
</html>
