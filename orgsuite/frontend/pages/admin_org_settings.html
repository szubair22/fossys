<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Settings - OrgSuite Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="/js/config.js?v=6"></script>
    <script src="/js/config.modules.js?v=1"></script>
    <script src="/js/ui.js?v=2"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/app.js?v=7"></script>
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 text-blue-600 font-bold text-xl hover:text-blue-700 transition-colors">
                <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>OrgSuite</span>
            </a>
            <nav class="flex items-center gap-6" id="nav-menu"></nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 py-10">
        <div class="max-w-4xl mx-auto px-6">
            <!-- Organization Selector -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Organization</label>
                <select id="org-selector" class="w-full max-w-xs px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadSettings()">
                    <option value="">Loading organizations...</option>
                </select>
            </div>

            <!-- Page Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <nav class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                        <a href="/pages/organizations.html" class="hover:text-blue-600">Organizations</a>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span class="text-gray-700">Admin</span>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span class="text-gray-900 font-medium">Organization Settings</span>
                    </nav>
                    <h1 class="text-3xl font-bold text-gray-900">Organization Settings</h1>
                    <p class="text-gray-500 mt-2">Configure general settings for your organization</p>
                </div>
            </div>

            <!-- Admin Navigation Tabs -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-2 mb-6">
                <div class="flex gap-2">
                    <a href="/pages/admin_org_settings.html" class="flex-1 px-4 py-2.5 text-center rounded-lg bg-blue-50 text-blue-700 font-medium">General</a>
                    <a href="/pages/admin_governance.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">Governance</a>
                    <a href="/pages/admin_membership.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">Membership</a>
                    <a href="/pages/admin_finance.html" class="flex-1 px-4 py-2.5 text-center rounded-lg text-gray-600 hover:bg-gray-50 font-medium">Finance</a>
                </div>
            </div>

            <!-- Settings Form -->
            <div id="settings-content" class="space-y-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" class="text-blue-600">
                                <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">General Settings</h2>
                            <p class="text-sm text-gray-500">Basic organization configuration</p>
                        </div>
                    </div>

                    <form id="general-settings-form" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                <select id="setting-timezone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (ET)</option>
                                    <option value="America/Chicago">Central Time (CT)</option>
                                    <option value="America/Denver">Mountain Time (MT)</option>
                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                    <option value="Europe/London">London (GMT)</option>
                                    <option value="Europe/Paris">Paris (CET)</option>
                                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Locale / Language</label>
                                <select id="setting-locale" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="en-US">English (US)</option>
                                    <option value="en-GB">English (UK)</option>
                                    <option value="es-ES">Spanish</option>
                                    <option value="fr-FR">French</option>
                                    <option value="de-DE">German</option>
                                    <option value="ja-JP">Japanese</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date Format</label>
                                <select id="setting-date-format" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="YYYY-MM-DD">2024-01-15 (ISO)</option>
                                    <option value="MM/DD/YYYY">01/15/2024 (US)</option>
                                    <option value="DD/MM/YYYY">15/01/2024 (EU)</option>
                                    <option value="DD.MM.YYYY">15.01.2024 (DE)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time Format</label>
                                <select id="setting-time-format" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="HH:mm">24-hour (14:30)</option>
                                    <option value="hh:mm A">12-hour (2:30 PM)</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-3 justify-end pt-5 border-t border-gray-100">
                            <button type="button" onclick="loadSettings()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">Reset</button>
                            <button type="submit" id="save-settings-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-sm">
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Organization Info (Read-only) -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor" class="text-gray-600">
                                <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Organization Info</h2>
                            <p class="text-sm text-gray-500">View organization details</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Organization Name</label>
                            <p id="org-name-display" class="text-gray-900 font-medium">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Description</label>
                            <p id="org-description-display" class="text-gray-700">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Your Role</label>
                            <p id="org-role-display" class="text-gray-700">-</p>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <a href="/pages/organization.html" id="edit-org-link" class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1">
                            Edit Organization Details
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6">
        <div class="max-w-7xl mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; 2024 OrgSuite. Open-source organization management platform.</p>
        </div>
    </footer>

    <script>
        let currentOrgId = '';
        let currentSettings = {};

        document.addEventListener('DOMContentLoaded', async () => {
            App.init();
            if (!App.requireAuth()) return;
            App.updateNav();

            // Load organizations for selector
            await loadOrganizations();

            // Setup form submission
            document.getElementById('general-settings-form').addEventListener('submit', saveSettings);
        });

        async function loadOrganizations() {
            const selector = document.getElementById('org-selector');
            try {
                const orgs = await App.getOrganizations();
                // Filter to only orgs where user is admin/owner
                const adminOrgs = orgs.filter(org =>
                    org.user_role === 'owner' || org.user_role === 'admin'
                );

                if (adminOrgs.length === 0) {
                    selector.innerHTML = '<option value="">No organizations with admin access</option>';
                    document.getElementById('settings-content').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 text-center">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor" class="text-yellow-500 mx-auto mb-4">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            <p class="text-yellow-800 font-medium">Admin Access Required</p>
                            <p class="text-yellow-700 text-sm mt-2">You need to be an organization admin or owner to access these settings.</p>
                        </div>
                    `;
                } else {
                    selector.innerHTML = '<option value="">Select organization...</option>' +
                        adminOrgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');

                    // Auto-select if only one org or from URL param
                    const urlOrgId = App.getUrlParam('org');
                    if (urlOrgId && adminOrgs.find(o => o.id === urlOrgId)) {
                        selector.value = urlOrgId;
                        loadSettings();
                    } else if (adminOrgs.length === 1) {
                        selector.value = adminOrgs[0].id;
                        loadSettings();
                    }
                }
            } catch (err) {
                console.error('Failed to load organizations:', err);
                selector.innerHTML = '<option value="">Error loading organizations</option>';
            }
        }

        async function loadSettings() {
            const orgId = document.getElementById('org-selector').value;
            if (!orgId) return;

            currentOrgId = orgId;

            try {
                // Load organization details
                const org = await App.getOrganization(orgId);
                if (org) {
                    document.getElementById('org-name-display').textContent = org.name;
                    document.getElementById('org-description-display').textContent = org.description || 'No description';
                    document.getElementById('org-role-display').textContent = (org.user_role || 'member').charAt(0).toUpperCase() + (org.user_role || 'member').slice(1);
                    document.getElementById('edit-org-link').href = `/pages/organization.html?id=${orgId}`;
                }

                // Load settings from API
                const response = await fetch(`/api/v1/admin/org-settings/effective?organization_id=${orgId}&scope=general`, {
                    headers: {
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentSettings = data.settings.general || {};

                    // Populate form fields
                    document.getElementById('setting-timezone').value = currentSettings.timezone || 'UTC';
                    document.getElementById('setting-locale').value = currentSettings.locale || 'en-US';
                    document.getElementById('setting-date-format').value = currentSettings.date_format || 'YYYY-MM-DD';
                    document.getElementById('setting-time-format').value = currentSettings.time_format || 'HH:mm';
                } else {
                    // No settings yet, use defaults
                    document.getElementById('setting-timezone').value = 'UTC';
                    document.getElementById('setting-locale').value = 'en-US';
                    document.getElementById('setting-date-format').value = 'YYYY-MM-DD';
                    document.getElementById('setting-time-format').value = 'HH:mm';
                }
            } catch (err) {
                console.error('Failed to load settings:', err);
                App.showNotification('Failed to load settings', 'error');
            }
        }

        async function saveSettings(event) {
            event.preventDefault();

            if (!currentOrgId) {
                App.showNotification('Please select an organization first', 'error');
                return;
            }

            const btn = document.getElementById('save-settings-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const settings = {
                    timezone: document.getElementById('setting-timezone').value,
                    locale: document.getElementById('setting-locale').value,
                    date_format: document.getElementById('setting-date-format').value,
                    time_format: document.getElementById('setting-time-format').value
                };

                // Save as a single config key
                const response = await fetch(`/api/v1/admin/org-settings/by-key?organization_id=${currentOrgId}&scope=general&key=general_config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    },
                    body: JSON.stringify({ value: settings })
                });

                if (!response.ok) {
                    throw new Error('Failed to save settings');
                }

                App.showNotification('Settings saved successfully!', 'success');
            } catch (err) {
                console.error('Failed to save settings:', err);
                App.showNotification('Failed to save settings', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Settings';
            }
        }

        // Update nav tab links with org parameter
        function updateNavLinks() {
            const orgId = document.getElementById('org-selector').value;
            if (orgId) {
                document.querySelectorAll('.bg-white.rounded-xl a').forEach(link => {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set('org', orgId);
                    link.href = url.toString();
                });
            }
        }

        // Call when org changes
        document.getElementById('org-selector').addEventListener('change', updateNavLinks);
    </script>
</body>
</html>
