<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donations - OrgSuite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/json-enc.js"></script>
    <script src="/js/config.js?v=6"></script>
    <script src="/js/ui.js?v=2"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/app.js?v=7"></script>
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .donor-type-btn { border-color: #d1d5db; color: #6b7280; }
        .donor-type-btn:hover { background-color: #f9fafb; }
        .donor-type-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col" hx-ext="json-enc">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 text-blue-600 font-bold text-xl hover:text-blue-700 transition-colors">
                <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>OrgSuite</span>
            </a>
            <nav class="flex items-center gap-6" id="nav-menu"></nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 py-10">
        <div class="max-w-7xl mx-auto px-6">
            <!-- Organization Selector -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Organization</label>
                <select id="org-selector" class="w-full max-w-xs px-4 py-2.5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDonations()">
                    <option value="">Loading organizations...</option>
                </select>
            </div>

            <!-- Page Header -->
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Donations</h1>
                    <p class="text-gray-500 mt-2">Track and manage donations received by your organization</p>
                </div>
                <button onclick="showAddDonationModal()" class="inline-flex items-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-xl font-medium hover:bg-blue-700 transition-all shadow-sm hover:shadow-md">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Record Donation
                </button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <div class="text-sm text-gray-500 mb-1">Total Received</div>
                    <div class="text-2xl font-bold text-green-600" id="total-received">$0.00</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <div class="text-sm text-gray-500 mb-1">Pending</div>
                    <div class="text-2xl font-bold text-yellow-600" id="total-pending">$0.00</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <div class="text-sm text-gray-500 mb-1">Pledged</div>
                    <div class="text-2xl font-bold text-blue-600" id="total-pledged">$0.00</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <div class="text-sm text-gray-500 mb-1">This Month</div>
                    <div class="text-2xl font-bold text-gray-900" id="total-month">$0.00</div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <!-- Status Filter -->
                    <div class="flex gap-2">
                        <button class="filter-btn active" data-status="" onclick="setStatusFilter(this, '')">All</button>
                        <button class="filter-btn" data-status="received" onclick="setStatusFilter(this, 'received')">Received</button>
                        <button class="filter-btn" data-status="pending" onclick="setStatusFilter(this, 'pending')">Pending</button>
                        <button class="filter-btn" data-status="pledged" onclick="setStatusFilter(this, 'pledged')">Pledged</button>
                    </div>
                    <!-- Date Range -->
                    <div class="flex gap-2 items-center">
                        <input type="date" id="start-date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDonations()">
                        <span class="text-gray-400">to</span>
                        <input type="date" id="end-date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="loadDonations()">
                    </div>
                    <!-- Search -->
                    <div class="flex-1 min-w-[200px]">
                        <input type="text" id="donation-search" placeholder="Search by donor name..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               oninput="debounceSearch()">
                    </div>
                </div>
            </div>

            <!-- Donations Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Date</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Donor</th>
                            <th class="text-right px-6 py-4 text-sm font-semibold text-gray-700">Amount</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Purpose</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Status</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Payment</th>
                            <th class="text-right px-6 py-4 text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="donations-table-body">
                        <tr>
                            <td colspan="7" class="text-center py-16">
                                <div class="inline-flex items-center gap-3 text-gray-400">
                                    <svg class="animate-spin" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                        <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
                                    </svg>
                                    <span>Select an organization to view donations</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-between items-center mt-6 hidden">
                <div class="text-sm text-gray-500">
                    Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-items">0</span> donations
                </div>
                <div class="flex gap-2">
                    <button id="prev-page" onclick="changePage(-1)" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
                    <button id="next-page" onclick="changePage(1)" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Donation Modal -->
    <div id="add-donation-modal" class="hidden modal-overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Record Donation</h2>
                <button onclick="hideAddDonationModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>

            <form id="add-donation-form" class="space-y-5" onsubmit="submitDonationForm(event)">
                <!-- Donor Type Selector -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Donor Type *</label>
                    <div class="flex gap-2">
                        <button type="button" class="donor-type-btn active flex-1 py-2 px-4 border rounded-lg text-sm font-medium transition-colors" data-type="anonymous" onclick="setDonorType('anonymous')">Anonymous/New</button>
                        <button type="button" class="donor-type-btn flex-1 py-2 px-4 border rounded-lg text-sm font-medium transition-colors" data-type="member" onclick="setDonorType('member')">Member</button>
                        <button type="button" class="donor-type-btn flex-1 py-2 px-4 border rounded-lg text-sm font-medium transition-colors" data-type="contact" onclick="setDonorType('contact')">Contact</button>
                    </div>
                </div>

                <!-- Anonymous/New Donor Fields -->
                <div id="anonymous-donor-fields">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Donor Name *</label>
                        <input type="text" name="donor_name" id="donation-donor-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Donor Email</label>
                        <input type="email" name="donor_email" id="donation-donor-email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Member Selector -->
                <div id="member-donor-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Member *</label>
                    <select name="member_id" id="donation-member-id" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Loading members...</option>
                    </select>
                </div>

                <!-- Contact Selector -->
                <div id="contact-donor-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Contact *</label>
                    <select name="contact_id" id="donation-contact-id" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Loading contacts...</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount *</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-500">$</span>
                            <input type="number" name="amount" id="donation-amount" class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                        <input type="date" name="donation_date" id="donation-date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                        <select name="payment_method" id="donation-payment" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select...</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="paypal">PayPal</option>
                            <option value="venmo">Venmo</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select name="status" id="donation-status" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="received">Received</option>
                            <option value="pending">Pending</option>
                            <option value="pledged">Pledged</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
                        <input type="text" name="purpose" id="donation-purpose" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., General Fund">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Campaign</label>
                        <input type="text" name="campaign" id="donation-campaign" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Annual Appeal">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Payment Reference</label>
                    <input type="text" name="payment_reference" id="donation-reference" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Check #1234">
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" name="is_tax_deductible" id="donation-tax" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <label for="donation-tax" class="text-sm text-gray-700">Tax deductible donation</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" id="donation-notes" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                </div>

                <div class="flex gap-3 justify-end pt-5 border-t border-gray-100">
                    <button type="button" onclick="hideAddDonationModal()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" id="submit-donation-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        Record Donation
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-6">
        <div class="max-w-7xl mx-auto px-6 text-center text-gray-500 text-sm">
            <p>&copy; 2024 OrgSuite. Open-source organization management platform.</p>
        </div>
    </footer>

    <script>
        let currentPage = 1;
        let currentStatus = '';
        let currentSearch = '';
        let searchTimeout = null;
        const perPage = 30;

        // Organization settings (loaded dynamically)
        let financeConfig = null;

        document.body.addEventListener('htmx:configRequest', function(event) {
            const token = App.pb?.authStore?.token;
            if (token) {
                event.detail.headers['Authorization'] = `Bearer ${token}`;
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            App.init();
            if (!App.requireAuth()) return;
            App.updateNav();

            // Set default date to today
            document.getElementById('donation-date').valueAsDate = new Date();

            await loadOrganizations();
        });

        // Fetch finance settings for the selected organization
        async function loadFinanceSettings(orgId) {
            if (!orgId) {
                financeConfig = null;
                return;
            }

            try {
                const response = await fetch(`/api/v1/settings/finance?organization_id=${orgId}`, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (response.ok) {
                    financeConfig = await response.json();
                    console.log('Loaded finance settings:', financeConfig);
                    updatePaymentMethodDropdown();
                    updateCurrencyDisplay();
                } else {
                    // Fall back to defaults if settings API fails
                    financeConfig = getDefaultFinanceConfig();
                    updatePaymentMethodDropdown();
                    updateCurrencyDisplay();
                }
            } catch (err) {
                console.warn('Failed to load finance settings, using defaults:', err);
                financeConfig = getDefaultFinanceConfig();
                updatePaymentMethodDropdown();
                updateCurrencyDisplay();
            }
        }

        // Default config (fallback)
        function getDefaultFinanceConfig() {
            return {
                fiscal_year_start_month: 1,
                default_currency: 'USD',
                enabled_dimensions: ['department', 'location', 'project'],
                payment_methods: ['Cash', 'Check', 'Credit Card', 'Bank Transfer', 'PayPal', 'Venmo', 'Other']
            };
        }

        // Update payment method dropdown based on settings
        function updatePaymentMethodDropdown() {
            const config = financeConfig || getDefaultFinanceConfig();
            const select = document.getElementById('donation-payment');

            if (select) {
                select.innerHTML = '<option value="">Select...</option>' +
                    config.payment_methods.map(method => {
                        const value = method.toLowerCase().replace(/ /g, '_');
                        return `<option value="${value}">${method}</option>`;
                    }).join('');
            }
        }

        // Update currency display based on settings
        function updateCurrencyDisplay() {
            const config = financeConfig || getDefaultFinanceConfig();
            const currencySymbol = getCurrencySymbol(config.default_currency);

            // Update the currency symbol in the form
            const currencySpan = document.querySelector('#donation-amount').previousElementSibling;
            if (currencySpan) {
                currencySpan.textContent = currencySymbol;
            }
        }

        // Get currency symbol for display
        function getCurrencySymbol(currency) {
            const symbols = {
                'USD': '$',
                'EUR': '€',
                'GBP': '£',
                'CAD': 'CA$',
                'AUD': 'A$',
                'JPY': '¥',
                'CHF': 'CHF',
                'NGN': '₦'
            };
            return symbols[currency] || currency;
        }

        async function loadOrganizations() {
            const selector = document.getElementById('org-selector');
            try {
                const orgs = await App.getOrganizations();
                if (orgs.length === 0) {
                    selector.innerHTML = '<option value="">No organizations found</option>';
                } else {
                    selector.innerHTML = '<option value="">Select organization...</option>' +
                        orgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');

                    const urlOrgId = App.getUrlParam('org');
                    if (urlOrgId) {
                        selector.value = urlOrgId;
                        loadDonations();
                    } else if (orgs.length === 1) {
                        selector.value = orgs[0].id;
                        loadDonations();
                    }
                }
            } catch (err) {
                console.error('Failed to load organizations:', err);
                selector.innerHTML = '<option value="">Error loading organizations</option>';
            }
        }

        async function loadDonations() {
            const orgId = document.getElementById('org-selector').value;
            const tbody = document.getElementById('donations-table-body');

            if (!orgId) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-16 text-gray-400">
                            Select an organization to view donations
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').classList.add('hidden');
                resetSummaryCards();
                financeConfig = null;
                return;
            }

            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-16">
                        <div class="inline-flex items-center gap-3 text-gray-400">
                            <svg class="animate-spin" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
                            </svg>
                            <span>Loading donations...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                // Load finance settings for this org
                await loadFinanceSettings(orgId);

                let url = `/api/v1/finance/donations?organization_id=${orgId}&page=${currentPage}&perPage=${perPage}`;
                if (currentStatus) url += `&status=${currentStatus}`;
                if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;

                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // API not implemented yet - show placeholder
                        showNotImplemented();
                        return;
                    }
                    throw new Error('Failed to fetch donations');
                }

                const data = await response.json();
                renderDonations(data);
                updateSummaryCards(data);
            } catch (err) {
                console.error('Failed to load donations:', err);
                showNotImplemented();
            }
        }

        function showNotImplemented() {
            const tbody = document.getElementById('donations-table-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-16">
                        <div class="w-16 h-16 bg-yellow-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor" class="text-yellow-600">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Donations API Coming Soon</h3>
                        <p class="text-gray-500">The donations endpoint is not yet implemented.<br>Check back later or create the API endpoint.</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').classList.add('hidden');
            resetSummaryCards();
        }

        function renderDonations(data) {
            const tbody = document.getElementById('donations-table-body');
            const donations = data.items || [];

            if (donations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-16">
                            <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor" class="text-gray-400">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No donations found</h3>
                            <p class="text-gray-500">Record your first donation to start tracking contributions</p>
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            tbody.innerHTML = donations.map(donation => {
                // Use resolved donor info from API response
                const donorName = donation.donor?.name || donation.donor_name || 'Anonymous';
                const donorEmail = donation.donor?.email || donation.donor_email;
                const donorType = donation.donor?.type || 'anonymous';
                const donorBadge = donorType === 'member' ? '<span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded ml-2">Member</span>' :
                                   donorType === 'contact' ? '<span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded ml-2">Contact</span>' : '';
                return `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 text-gray-600">${App.formatShortDate(donation.donation_date)}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${donorName}${donorBadge}</div>
                        ${donorEmail ? `<div class="text-sm text-gray-500">${donorEmail}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="font-semibold text-gray-900">${formatCurrency(donation.amount)}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${donation.purpose || donation.campaign || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="badge ${getDonationStatusBadgeClass(donation.status)}">${donation.status}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600 capitalize">${formatPaymentMethod(donation.payment_method)}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="editDonation('${donation.id}')" class="text-blue-600 hover:text-blue-800 font-medium text-sm">Edit</button>
                    </td>
                </tr>
            `}).join('');

            updatePagination(data);
        }

        function getDonationStatusBadgeClass(status) {
            const classes = {
                received: 'bg-green-100 text-green-700',
                pending: 'bg-yellow-100 text-yellow-700',
                pledged: 'bg-blue-100 text-blue-700',
                cancelled: 'bg-gray-100 text-gray-700',
                refunded: 'bg-red-100 text-red-700'
            };
            return classes[status] || 'bg-gray-100 text-gray-700';
        }

        function formatPaymentMethod(method) {
            if (!method) return '-';
            return method.replace(/_/g, ' ');
        }

        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            const config = financeConfig || getDefaultFinanceConfig();
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: config.default_currency
            }).format(num);
        }

        async function loadSummaryCards() {
            const orgId = document.getElementById('org-selector').value;
            if (!orgId) {
                resetSummaryCards();
                return;
            }

            try {
                // Get summary for all time
                let summaryUrl = `/api/v1/finance/donations/summary?organization_id=${orgId}`;
                const summaryResponse = await fetch(summaryUrl, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (summaryResponse.ok) {
                    const summary = await summaryResponse.json();
                    document.getElementById('total-received').textContent = formatCurrency(summary.total_received);
                    document.getElementById('total-pending').textContent = formatCurrency(summary.total_pending);
                    document.getElementById('total-pledged').textContent = formatCurrency(summary.total_pledged);
                }

                // Get this month's total
                const now = new Date();
                const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                let monthUrl = `/api/v1/finance/donations/summary?organization_id=${orgId}&start_date=${firstOfMonth}`;
                const monthResponse = await fetch(monthUrl, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (monthResponse.ok) {
                    const monthSummary = await monthResponse.json();
                    document.getElementById('total-month').textContent = formatCurrency(monthSummary.total_received);
                }
            } catch (err) {
                console.error('Failed to load summary:', err);
            }
        }

        function updateSummaryCards(data) {
            // Use the dedicated summary endpoint instead of calculating from items
            loadSummaryCards();
        }

        function resetSummaryCards() {
            document.getElementById('total-received').textContent = '$0.00';
            document.getElementById('total-pending').textContent = '$0.00';
            document.getElementById('total-pledged').textContent = '$0.00';
            document.getElementById('total-month').textContent = '$0.00';
        }

        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            const totalItems = data.totalItems || 0;
            const totalPages = data.totalPages || 1;

            if (totalItems === 0) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');

            const start = (currentPage - 1) * perPage + 1;
            const end = Math.min(currentPage * perPage, totalItems);

            document.getElementById('showing-start').textContent = start;
            document.getElementById('showing-end').textContent = end;
            document.getElementById('total-items').textContent = totalItems;

            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function setStatusFilter(btn, status) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentStatus = status;
            currentPage = 1;
            loadDonations();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = document.getElementById('donation-search').value;
                currentPage = 1;
                loadDonations();
            }, 300);
        }

        function changePage(delta) {
            currentPage += delta;
            loadDonations();
        }

        function showAddDonationModal() {
            const orgId = document.getElementById('org-selector').value;
            if (!orgId) {
                App.showNotification('Please select an organization first', 'error');
                return;
            }
            document.getElementById('add-donation-form').reset();
            document.getElementById('donation-date').valueAsDate = new Date();
            document.getElementById('donation-tax').checked = true;

            // Reset donor type to anonymous
            setDonorType('anonymous');

            document.getElementById('add-donation-modal').classList.remove('hidden');
        }

        function hideAddDonationModal() {
            document.getElementById('add-donation-modal').classList.add('hidden');
        }

        async function submitDonationForm(event) {
            event.preventDefault();

            const orgId = document.getElementById('org-selector').value;
            const submitBtn = document.getElementById('submit-donation-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Recording...';

            // Build form data based on donor type
            const formData = {
                amount: parseFloat(document.getElementById('donation-amount').value),
                donation_date: document.getElementById('donation-date').value,
                payment_method: document.getElementById('donation-payment').value || null,
                status: document.getElementById('donation-status').value,
                purpose: document.getElementById('donation-purpose').value || null,
                campaign: document.getElementById('donation-campaign').value || null,
                payment_reference: document.getElementById('donation-reference').value || null,
                is_tax_deductible: document.getElementById('donation-tax').checked,
                notes: document.getElementById('donation-notes').value || null
            };

            // Add donor info based on selected type
            if (currentDonorType === 'anonymous') {
                const donorName = document.getElementById('donation-donor-name').value;
                if (!donorName) {
                    App.showNotification('Please enter a donor name', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Record Donation';
                    return;
                }
                formData.donor_name = donorName;
                formData.donor_email = document.getElementById('donation-donor-email').value || null;
            } else if (currentDonorType === 'member') {
                const memberId = document.getElementById('donation-member-id').value;
                if (!memberId) {
                    App.showNotification('Please select a member', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Record Donation';
                    return;
                }
                formData.member_id = memberId;
            } else if (currentDonorType === 'contact') {
                const contactId = document.getElementById('donation-contact-id').value;
                if (!contactId) {
                    App.showNotification('Please select a contact', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Record Donation';
                    return;
                }
                formData.contact_id = contactId;
            }

            try {
                const response = await fetch(`/api/v1/finance/donations?organization_id=${orgId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        App.showNotification('Donations API not yet implemented', 'warning');
                        hideAddDonationModal();
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to record donation');
                }

                App.showNotification('Donation recorded successfully!', 'success');
                hideAddDonationModal();
                loadDonations();
            } catch (err) {
                App.showNotification(err.message || 'Failed to record donation', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Record Donation';
            }
        }

        function editDonation(donationId) {
            App.showNotification('Edit functionality coming soon', 'info');
        }

        let currentDonorType = 'anonymous';

        function setDonorType(type) {
            currentDonorType = type;

            // Update button states
            document.querySelectorAll('.donor-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });

            // Show/hide appropriate fields
            document.getElementById('anonymous-donor-fields').classList.toggle('hidden', type !== 'anonymous');
            document.getElementById('member-donor-field').classList.toggle('hidden', type !== 'member');
            document.getElementById('contact-donor-field').classList.toggle('hidden', type !== 'contact');

            // Load members/contacts if needed
            const orgId = document.getElementById('org-selector').value;
            if (type === 'member' && orgId) {
                loadMembersForDonation(orgId);
            } else if (type === 'contact' && orgId) {
                loadContactsForDonation(orgId);
            }
        }

        async function loadMembersForDonation(orgId) {
            const select = document.getElementById('donation-member-id');
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const response = await fetch(`/api/v1/membership/members?organization_id=${orgId}&perPage=500`, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const members = data.items || [];

                    if (members.length === 0) {
                        select.innerHTML = '<option value="">No members found</option>';
                    } else {
                        select.innerHTML = '<option value="">Select a member...</option>' +
                            members.map(m => `<option value="${m.id}">${m.name}${m.email ? ` (${m.email})` : ''}</option>`).join('');
                    }
                } else {
                    select.innerHTML = '<option value="">Failed to load members</option>';
                }
            } catch (err) {
                console.error('Failed to load members:', err);
                select.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        async function loadContactsForDonation(orgId) {
            const select = document.getElementById('donation-contact-id');
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const response = await fetch(`/api/v1/membership/contacts?organization_id=${orgId}&perPage=500&contact_type=donor`, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const contacts = data.items || [];

                    if (contacts.length === 0) {
                        select.innerHTML = '<option value="">No donor contacts found</option>';
                    } else {
                        select.innerHTML = '<option value="">Select a contact...</option>' +
                            contacts.map(c => `<option value="${c.id}">${c.name}${c.email ? ` (${c.email})` : ''}</option>`).join('');
                    }
                } else {
                    select.innerHTML = '<option value="">Failed to load contacts</option>';
                }
            } catch (err) {
                console.error('Failed to load contacts:', err);
                select.innerHTML = '<option value="">Error loading contacts</option>';
            }
        }
    </script>
</body>
</html>
