<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart of Accounts - OrgSuite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/config.js?v=6"></script>
    <script src="/js/ui.js?v=3"></script>
    <script src="/js/api.js?v=2"></script>
    <script src="/js/app.js?v=8"></script>
    <script src="/js/layout.js?v=1"></script>
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/theme.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="app-shell">
    <!-- Header - Rendered by Layout.js -->
    <header class="app-header"></header>

    <!-- Module Navigation -->
    <nav class="module-nav"></nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="app-main-inner">
            <!-- Hidden org selector for test compatibility - org selection is in header -->
            <select id="org-selector" data-testid="org-selector" class="hidden" onchange="loadAccounts()">
                <option value="">Loading organizations...</option>
            </select>

            <!-- Page Header -->
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <nav class="page-breadcrumb">
                        <a href="/pages/dashboard.html">Dashboard</a>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span>Finance</span>
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                        <span style="color: var(--color-text-primary); font-weight: 500;">Chart of Accounts</span>
                    </nav>
                    <h1 class="page-title">Chart of Accounts</h1>
                    <p class="page-description">Manage your organization's accounts for double-entry bookkeeping</p>
                </div>
                <button onclick="showAddAccountModal()" class="btn btn-primary" style="padding: 0.75rem 1.25rem;" data-require-role="admin" data-testid="add-account-btn" id="add-account-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Add Account
                </button>
            </div>

            <!-- Filter Bar -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <!-- Account Type Filter -->
                    <div class="flex gap-2 flex-wrap">
                        <button class="filter-btn active" data-type="" onclick="setTypeFilter(this, '')">All</button>
                        <button class="filter-btn" data-type="asset" onclick="setTypeFilter(this, 'asset')">Assets</button>
                        <button class="filter-btn" data-type="liability" onclick="setTypeFilter(this, 'liability')">Liabilities</button>
                        <button class="filter-btn" data-type="equity" onclick="setTypeFilter(this, 'equity')">Equity</button>
                        <button class="filter-btn" data-type="revenue" onclick="setTypeFilter(this, 'revenue')">Revenue</button>
                        <button class="filter-btn" data-type="expense" onclick="setTypeFilter(this, 'expense')">Expenses</button>
                    </div>
                    <!-- Search -->
                    <div class="flex-1 min-w-[200px]">
                        <input type="text" id="account-search" placeholder="Search by code or name..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               oninput="debounceSearch()">
                    </div>
                    <!-- Active Toggle -->
                    <label class="flex items-center gap-2 text-sm text-gray-600">
                        <input type="checkbox" id="show-inactive" onchange="loadAccounts()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        Show inactive
                    </label>
                </div>
            </div>

            <!-- Accounts Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Code</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Name</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Type</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Subtype</th>
                            <th class="text-left px-6 py-4 text-sm font-semibold text-gray-700">Status</th>
                            <th class="text-right px-6 py-4 text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accounts-table-body">
                        <tr>
                            <td colspan="6" class="text-center py-16">
                                <div class="inline-flex items-center gap-3 text-gray-400">
                                    <svg class="animate-spin" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                        <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
                                    </svg>
                                    <span>Select an organization to view accounts</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-between items-center mt-6 hidden">
                <div class="text-sm text-gray-500">
                    Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-items">0</span> accounts
                </div>
                <div class="flex gap-2">
                    <button id="prev-page" onclick="changePage(-1)" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
                    <button id="next-page" onclick="changePage(1)" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Next</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Account Modal -->
    <div id="add-account-modal" class="hidden modal-overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Add New Account</h2>
                <button onclick="hideAddAccountModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>

            <form id="add-account-form" class="space-y-5" onsubmit="submitAccountForm(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Code *</label>
                        <input type="text" name="code" id="account-code" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 1000" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Type *</label>
                        <select name="account_type" id="account-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required onchange="updateSubtypeOptions()">
                            <option value="asset">Asset</option>
                            <option value="liability">Liability</option>
                            <option value="equity">Equity</option>
                            <option value="revenue">Revenue</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                    <input type="text" name="name" id="account-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Cash" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Subtype</label>
                    <select name="account_subtype" id="account-subtype" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">None</option>
                        <!-- Dynamically populated based on account type -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea name="description" id="account-description" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Parent Account</label>
                        <select name="parent_id" id="account-parent" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">None (Top Level)</option>
                            <!-- Populated with existing accounts -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                        <input type="number" name="display_order" id="account-order" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="0">
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" id="account-active" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                    <label for="account-active" class="text-sm text-gray-700">Active account</label>
                </div>

                <div class="flex gap-3 justify-end pt-5 border-t border-gray-100">
                    <button type="button" onclick="hideAddAccountModal()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" id="submit-account-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        Add Account
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div id="edit-account-modal" class="hidden modal-overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Edit Account</h2>
                <button onclick="hideEditAccountModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>

            <form id="edit-account-form" class="space-y-5" onsubmit="submitEditAccountForm(event)">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Code *</label>
                        <input type="text" id="edit-account-code" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Account Type *</label>
                        <select id="edit-account-type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required onchange="updateEditSubtypeOptions()">
                            <option value="asset">Asset</option>
                            <option value="liability">Liability</option>
                            <option value="equity">Equity</option>
                            <option value="revenue">Revenue</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name *</label>
                    <input type="text" id="edit-account-name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Subtype</label>
                    <select id="edit-account-subtype" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">None</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="edit-account-description" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Parent Account</label>
                        <select id="edit-account-parent" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                        <input type="number" id="edit-account-order" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="0">
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="edit-account-active" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="edit-account-active" class="text-sm text-gray-700">Active account</label>
                </div>

                <div class="flex gap-3 justify-end pt-5 border-t border-gray-100">
                    <button type="button" onclick="deleteAccount()" class="px-5 py-2.5 border border-red-300 text-red-600 rounded-xl font-medium hover:bg-red-50 transition-colors mr-auto">Delete</button>
                    <button type="button" onclick="hideEditAccountModal()" class="px-5 py-2.5 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" id="submit-edit-account-btn" class="px-5 py-2.5 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <p>&copy; 2024 OrgSuite. Open-source organization management platform.</p>
    </footer>

    <script>
        let currentPage = 1;
        let currentType = '';
        let currentSearch = '';
        let searchTimeout = null;
        let allAccounts = [];
        let currentOrgId = null;
        const perPage = 100;

        // Subtype options by account type
        const subtypesByType = {
            asset: ['cash', 'bank', 'accounts_receivable', 'inventory', 'prepaid', 'fixed_asset', 'accumulated_depreciation', 'other_asset'],
            liability: ['accounts_payable', 'credit_card', 'accrued_liabilities', 'deferred_revenue', 'long_term_debt', 'other_liability'],
            equity: ['retained_earnings', 'common_stock', 'paid_in_capital', 'other_equity'],
            revenue: ['donations', 'grants', 'membership_dues', 'program_revenue', 'investment_income', 'other_revenue'],
            expense: ['salaries', 'benefits', 'rent', 'utilities', 'supplies', 'professional_fees', 'depreciation', 'other_expense']
        };

        document.addEventListener('DOMContentLoaded', async () => {
            App.init();
            if (!App.requireAuth()) return;

            // Initialize Layout system
            Layout.init({ module: 'finance' });
            Layout.renderModuleNav('finance', 'chart-of-accounts');

            updateSubtypeOptions();

            // Wait for organizations to load, then sync hidden selector
            await loadOrganizations();

            // Listen for org changes from Layout
            window.addEventListener('orgchange', (e) => {
                if (e.detail.orgId) {
                    currentOrgId = e.detail.orgId;
                    document.getElementById('org-selector').value = e.detail.orgId;
                    loadAccounts();
                }
            });
        });

        async function loadOrganizations() {
            const selector = document.getElementById('org-selector');
            try {
                const orgs = await App.getOrganizations();
                if (orgs.length === 0) {
                    selector.innerHTML = '<option value="">No organizations found</option>';
                } else {
                    selector.innerHTML = '<option value="">Select organization...</option>' +
                        orgs.map(org => `<option value="${org.id}">${org.name}</option>`).join('');

                    const urlOrgId = UI.getUrlParam('org');
                    if (urlOrgId) {
                        selector.value = urlOrgId;
                        currentOrgId = urlOrgId;
                        loadAccounts();
                    } else if (orgs.length === 1) {
                        selector.value = orgs[0].id;
                        currentOrgId = orgs[0].id;
                        loadAccounts();
                    }
                }
            } catch (err) {
                console.error('Failed to load organizations:', err);
                selector.innerHTML = '<option value="">Error loading organizations</option>';
            }
        }

        async function loadAccounts() {
            const orgId = document.getElementById('org-selector').value || currentOrgId;
            const tbody = document.getElementById('accounts-table-body');
            const showInactive = document.getElementById('show-inactive').checked;

            if (!orgId) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-16 text-gray-400">
                            Select an organization to view accounts
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-16">
                        <div class="inline-flex items-center gap-3 text-gray-400">
                            <svg class="animate-spin" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
                                <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>
                            </svg>
                            <span>Loading accounts...</span>
                        </div>
                    </td>
                </tr>
            `;

            try {
                let url = `/api/v1/finance/accounts?organization_id=${orgId}&page=${currentPage}&perPage=${perPage}`;
                if (currentType) url += `&account_type=${currentType}`;
                if (!showInactive) url += `&is_active=true`;
                if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch accounts');

                const data = await response.json();
                allAccounts = data.items || [];
                renderAccounts(data);
                updateParentOptions();
            } catch (err) {
                console.error('Failed to load accounts:', err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-16 text-red-500">
                            Failed to load accounts. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        function renderAccounts(data) {
            const tbody = document.getElementById('accounts-table-body');
            const accounts = data.items || [];

            if (accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-16">
                            <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor" class="text-gray-400">
                                    <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No accounts found</h3>
                            <p class="text-gray-500">Add your first account to set up your chart of accounts</p>
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            tbody.innerHTML = accounts.map(account => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors ${!account.is_active ? 'opacity-50' : ''}">
                    <td class="px-6 py-4">
                        <span class="font-mono text-sm font-medium text-gray-900">${account.code}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${account.name}</div>
                        ${account.description ? `<div class="text-sm text-gray-500 truncate max-w-xs">${account.description}</div>` : ''}
                    </td>
                    <td class="px-6 py-4">
                        <span class="badge ${getAccountTypeBadgeClass(account.account_type)}">${formatAccountType(account.account_type)}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600 capitalize">${account.account_subtype ? formatAccountType(account.account_subtype) : '-'}</td>
                    <td class="px-6 py-4">
                        ${account.is_active
                            ? '<span class="badge bg-green-100 text-green-700">Active</span>'
                            : '<span class="badge bg-gray-100 text-gray-700">Inactive</span>'}
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${!account.is_system ? `<button onclick="editAccount('${account.id}')" class="text-blue-600 hover:text-blue-800 font-medium text-sm">Edit</button>` : '<span class="text-gray-400 text-sm">System</span>'}
                    </td>
                </tr>
            `).join('');

            updatePagination(data);
        }

        function getAccountTypeBadgeClass(type) {
            const classes = {
                asset: 'bg-blue-100 text-blue-700',
                liability: 'bg-red-100 text-red-700',
                equity: 'bg-purple-100 text-purple-700',
                revenue: 'bg-green-100 text-green-700',
                expense: 'bg-orange-100 text-orange-700'
            };
            return classes[type] || 'bg-gray-100 text-gray-700';
        }

        function formatAccountType(type) {
            if (!type) return '';
            return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            const totalItems = data.totalItems || 0;
            const totalPages = data.totalPages || 1;

            if (totalItems === 0) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');

            const start = (currentPage - 1) * perPage + 1;
            const end = Math.min(currentPage * perPage, totalItems);

            document.getElementById('showing-start').textContent = start;
            document.getElementById('showing-end').textContent = end;
            document.getElementById('total-items').textContent = totalItems;

            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function setTypeFilter(btn, type) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            currentType = type;
            currentPage = 1;
            loadAccounts();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = document.getElementById('account-search').value;
                currentPage = 1;
                loadAccounts();
            }, 300);
        }

        function changePage(delta) {
            currentPage += delta;
            loadAccounts();
        }

        function updateSubtypeOptions() {
            const type = document.getElementById('account-type').value;
            const subtypeSelect = document.getElementById('account-subtype');
            const subtypes = subtypesByType[type] || [];

            subtypeSelect.innerHTML = '<option value="">None</option>' +
                subtypes.map(st => `<option value="${st}">${formatAccountType(st)}</option>`).join('');
        }

        function updateParentOptions() {
            const parentSelect = document.getElementById('account-parent');
            parentSelect.innerHTML = '<option value="">None (Top Level)</option>' +
                allAccounts.filter(a => a.is_active).map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
        }

        function showAddAccountModal() {
            const orgId = document.getElementById('org-selector').value || currentOrgId;
            if (!orgId) {
                App.showNotification('Please select an organization first', 'error');
                return;
            }
            document.getElementById('add-account-modal').classList.remove('hidden');
        }

        function hideAddAccountModal() {
            document.getElementById('add-account-modal').classList.add('hidden');
            document.getElementById('add-account-form').reset();
            document.getElementById('account-active').checked = true;
        }

        async function submitAccountForm(event) {
            event.preventDefault();

            const orgId = document.getElementById('org-selector').value || currentOrgId;
            const submitBtn = document.getElementById('submit-account-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            const formData = {
                code: document.getElementById('account-code').value,
                name: document.getElementById('account-name').value,
                account_type: document.getElementById('account-type').value,
                account_subtype: document.getElementById('account-subtype').value || null,
                description: document.getElementById('account-description').value || null,
                parent_id: document.getElementById('account-parent').value || null,
                display_order: parseInt(document.getElementById('account-order').value) || 0,
                is_active: document.getElementById('account-active').checked
            };

            try {
                const response = await fetch(`/api/v1/finance/accounts?organization_id=${orgId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail?.code?.message || error.detail || 'Failed to add account');
                }

                App.showNotification('Account added successfully!', 'success');
                hideAddAccountModal();
                loadAccounts();
            } catch (err) {
                App.showNotification(err.message || 'Failed to add account', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Account';
            }
        }

        let editingAccountId = null;

        async function editAccount(accountId) {
            const orgId = document.getElementById('org-selector').value || currentOrgId;
            editingAccountId = accountId;

            try {
                const response = await fetch(`/api/v1/finance/accounts/${accountId}?organization_id=${orgId}`, {
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch account');

                const account = await response.json();

                // Populate the edit form
                document.getElementById('edit-account-code').value = account.code || '';
                document.getElementById('edit-account-name').value = account.name || '';
                document.getElementById('edit-account-type').value = account.account_type || 'asset';
                updateEditSubtypeOptions();
                document.getElementById('edit-account-subtype').value = account.account_subtype || '';
                document.getElementById('edit-account-description').value = account.description || '';
                document.getElementById('edit-account-order').value = account.display_order || 0;
                document.getElementById('edit-account-active').checked = account.is_active;

                // Update parent options excluding the current account
                updateEditParentOptions(accountId);
                document.getElementById('edit-account-parent').value = account.parent_id || '';

                document.getElementById('edit-account-modal').classList.remove('hidden');
            } catch (err) {
                App.showNotification('Failed to load account details', 'error');
            }
        }

        function hideEditAccountModal() {
            document.getElementById('edit-account-modal').classList.add('hidden');
            editingAccountId = null;
        }

        function updateEditSubtypeOptions() {
            const type = document.getElementById('edit-account-type').value;
            const subtypeSelect = document.getElementById('edit-account-subtype');
            const currentValue = subtypeSelect.value;
            const subtypes = subtypesByType[type] || [];

            subtypeSelect.innerHTML = '<option value="">None</option>' +
                subtypes.map(st => `<option value="${st}">${formatAccountType(st)}</option>`).join('');

            // Restore value if it exists in new options
            if (subtypes.includes(currentValue)) {
                subtypeSelect.value = currentValue;
            }
        }

        function updateEditParentOptions(excludeId) {
            const parentSelect = document.getElementById('edit-account-parent');
            parentSelect.innerHTML = '<option value="">None (Top Level)</option>' +
                allAccounts.filter(a => a.is_active && a.id !== excludeId).map(a => `<option value="${a.id}">${a.code} - ${a.name}</option>`).join('');
        }

        async function submitEditAccountForm(event) {
            event.preventDefault();

            const orgId = document.getElementById('org-selector').value || currentOrgId;
            const submitBtn = document.getElementById('submit-edit-account-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const formData = {
                code: document.getElementById('edit-account-code').value,
                name: document.getElementById('edit-account-name').value,
                account_type: document.getElementById('edit-account-type').value,
                account_subtype: document.getElementById('edit-account-subtype').value || null,
                description: document.getElementById('edit-account-description').value || null,
                parent_id: document.getElementById('edit-account-parent').value || null,
                display_order: parseInt(document.getElementById('edit-account-order').value) || 0,
                is_active: document.getElementById('edit-account-active').checked
            };

            try {
                const response = await fetch(`/api/v1/finance/accounts/${editingAccountId}?organization_id=${orgId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.pb.authStore.token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail?.code?.message || error.detail || 'Failed to update account');
                }

                App.showNotification('Account updated successfully!', 'success');
                hideEditAccountModal();
                loadAccounts();
            } catch (err) {
                App.showNotification(err.message || 'Failed to update account', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        }

        async function deleteAccount() {
            const account = allAccounts.find(a => a.id === editingAccountId);
            const accountName = account ? `${account.code} - ${account.name}` : 'this account';

            if (!confirm(`Are you sure you want to delete "${accountName}"? This action cannot be undone.`)) {
                return;
            }

            const orgId = document.getElementById('org-selector').value || currentOrgId;

            try {
                const response = await fetch(`/api/v1/finance/accounts/${editingAccountId}?organization_id=${orgId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${App.pb.authStore.token}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete account');
                }

                App.showNotification('Account deleted successfully', 'success');
                hideEditAccountModal();
                loadAccounts();
            } catch (err) {
                App.showNotification(err.message || 'Failed to delete account', 'error');
            }
        }
    </script>
</body>
</html>
